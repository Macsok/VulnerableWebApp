# File: .github/workflows/workflow.yml

on: [push]

name: Run Azure Login With a Service Principal Secret

jobs:

  build-and-deploy:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v4
      name: Check out code

    - uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        enable-AzPSSession: true

    # - name: Azure CLI script
    #   uses: azure/cli@v2
    #   with:
    #     azcliversion: latest
    #     inlineScript: |
    #       az account show

    - name: Run kubectl apply -k .
      uses: azure/powershell@v2
      with:
        azPSVersion: "latest"
        # $Env:TLS_CRT = {{ secrets.TLS_CRT }}
        # $Env:TLS_KEY = {{ secrets.TLS_KEY }}
        inlineScript: |
          echo {{ secrets.TLS_CRT }} > cert-bundle.crt
          echo {{ secrets.TLS_KEY }} > private.key
          echo {{ secrets.ENV }} > .env
          az aks get-credentials --resource-group vulnerable-web-app-rg --name vulnerableWebappAKS
          cd kubernetes
          kubectl apply -k .
