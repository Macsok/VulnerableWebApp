{% extends "base.html" %}

{% block title %}Czat{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <h2 class="card-title mb-4">üí¨ Czat</h2>
        <form id="messageForm" method="POST" action="{{ url_for('send_message') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <textarea class="form-control" id="messageContent" name="content" rows="3" placeholder="Napisz wiadomo≈õƒá..." required></textarea>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send"></i> Wy≈õlij wiadomo≈õƒá
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Od≈õwie≈º
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h3 class="card-title mb-4">
            Wiadomo≈õci
            <small class="text-muted" id="lastUpdate"></small>
        </h3>
        <div id="messagesContainer">
        {% if messages %}
            {% for message in messages %}
            <div class="message-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="message-author">{{ message.author.username }}</div>
                        <div class="message-time">{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                        <div class="mt-2">{{ message.content }}</div>
                    </div>
                    {% if message.user_id == session['user_id'] %}
                    <form method="POST" action="{{ url_for('delete_message', message_id=message.id) }}" class="ms-2" onsubmit="return confirm('Czy na pewno chcesz usunƒÖƒá tƒô wiadomo≈õƒá?')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="bi bi-trash"></i> Usu≈Ñ
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted text-center">Brak wiadomo≈õci. Napisz pierwszƒÖ!</p>
        {% endif %}
        </div>
    </div>
</div>

<script>
// Automatyczne od≈õwie≈ºanie czasu ostatniej aktualizacji
function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pl-PL');
    document.getElementById('lastUpdate').textContent = `(ostatnia aktualizacja: ${timeString})`;
}

// Obs≈Çuga formularza - wys≈Çanie i od≈õwie≈ºenie strony
document.getElementById('messageForm').addEventListener('submit', function(e) {
    // Formularz zostanie wys≈Çany normalnie (POST)
    // Po wys≈Çaniu strona automatycznie siƒô od≈õwie≈ºy przez redirect z backendu
    
    // Opcjonalnie: wyczy≈õƒá pole tekstowe po wys≈Çaniu
    setTimeout(() => {
        document.getElementById('messageContent').value = '';
    }, 100);
});

// Automatyczne od≈õwie≈ºanie strony co 30 sekund (opcjonalne)
let autoRefreshEnabled = false; // Zmie≈Ñ na true aby w≈ÇƒÖczyƒá auto-od≈õwie≈ºanie

if (autoRefreshEnabled) {
    setInterval(function() {
        location.reload();
    }, 30000); // 30 sekund
}

// Aktualizuj czas przy za≈Çadowaniu strony
updateLastUpdateTime();

// Scroll do g√≥ry po za≈Çadowaniu (aby zobaczyƒá formularz)
window.scrollTo(0, 0);
</script>

{% endblock %}
